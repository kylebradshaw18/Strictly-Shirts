<?php 
  // Start the session
  session_start();
  require_once('Globals/connection.php');
  require_once('Globals/buildHTML.php');
  
  //Check if session variable is set  if not then go to sign in page
	if(!isset($_SESSION['personId']) || empty($_SESSION['personId'])) {
		header('Location: signin.php?navigation='.substr($_SERVER['REQUEST_URI'],1,strlen($_SERVER['REQUEST_URI']) - 1));
	}
  
  buildHTMLHeadLinks('true');// Builds all of the links takes in parameter for the auto slider needs to be a string
  buildHeader(); //Builds the Header and Navigation Bar?>
  <script src="./Page Functions/cart.js"></script>
  <div class='container'>
    <div class='check-out'>
      <h2 align="center">View Cart</h2>
      <?php //Check if the users cart is empty
        $cartResult = $conn->query("SELECT `inventoryId` , `quantity` FROM `carts` WHERE `personId` = ".$_SESSION['personId']);
        if($cartResult ->num_rows < 1){ // There are no items in cart ?>
          <div class="text-center"><h3>Your cart is empty <hr style="width:25%;"></h3></div>
      <?php } else{  ?>
          <table>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
              <th>Action</th>
            </tr> 
      <?php //Loop through the users cart
    	    while ($cartRow = mysqli_fetch_array($cartResult, MYSQL_ASSOC)) {
    	           $inventoryId = $cartRow['inventoryId'];
    	           $quantity = $cartRow['quantity'];
    	           
    	           //get details for a specific inventory
                     $queryDetails = "SELECT inventory.price, inventory.productId ".
                     "FROM inventory,carts ".
                     "WHERE inventory.inventoryId = '$inventoryId'";
                     $resDetails = $conn->query($queryDetails);
                     $rowDetails = mysqli_fetch_array($resDetails, MYSQL_ASSOC);
                     $price = $rowDetails['price'];
                     $productId = $rowDetails['productId'];
                     
                     
                     //get the design for a particular product
                     $queryDesign =   "SELECT designs.design ".
                     "FROM products,designs ".
                     "WHERE products.designId = designs.designId ".
                     "AND products.productId = '$productId'";
                     $resDesign = $conn->query($queryDesign);
                     $rowDesign = mysqli_fetch_array($resDesign);
                     $design = $rowDesign["design"];
                     
                     //get the size for a particular product
                     $querySize =   "SELECT sizes.size ".
                     "FROM inventory,sizes ".
                     "WHERE inventory.sizeId = sizes.sizeId ".
                     "AND inventory.inventoryId = '$inventoryId'";
                     $resSize = $conn->query($querySize);
                     //echo("Error description: " . mysqli_error($conn));
                     $rowSize = mysqli_fetch_array($resSize);
                     $size = $rowSize["design"];
                     
                    echo "<tr>";
                    echo "<td class='ring-in'><a href='#' class='at-in'><img src='images/productsImages/".$productId.".jpg' class='img-responsive' alt=''></a>";
                    echo "<div class='sed'>";
                    //We should probably add a name and description to shirts in the database.
                    echo "<h5>".$design."</h5>";
                    echo "</div>";
                    echo "<div class='clearfix'> </div></td>";
                    echo "<td> " .$quantity. "</td>";		
                    
                    echo "<td> $ ".$price."</td>";
                    echo "<td id='subTotal-".$cartRow['cartId'] ."'>$ ".($price * $quantity)." </td>";
                    ?>
                    <td> <button class='btn btn-primary' onclick='removeFromCart(<?php echo $cartRow['cartId'].",".$quantity?>)' id='removeFromCart<?php echo $cartRow['cartId']?>'>Remove Item</button></td>
                    </tr>
                    <?php
    	             
    	             
    	             
                    
    	           
    	    }?>
    	          	</table>
    	          	<a href='checkout.php' class=' to-buy'>PROCEED TO BUY</a>
                	<div class='clearfix'> </div>
    	     <?php 	} ?>
  </div>
</div>
<?php  buildFooter(false); //Builds the Footer ?>